name: Codex -> PR

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "What should Codex do?"
        required: true
        type: string

jobs:
  codex_pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # Run Codex and let it edit files in the workspace
      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: ${{ github.event.inputs.prompt }}
          # Allow Codex to write changes to the checked-out repo
          sandbox: workspace-write
          safety-strategy: drop-sudo
          # Run non-interactively (automation)
          codex-args: '["--full-auto"]'
          output-file: codex-output.md

      # Create a PR from whatever changes Codex made
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "codex: apply requested changes"
          title: "Codex: ${{ github.event.inputs.prompt }}"
          body: |
            This PR was generated by Codex via GitHub Actions.

            Prompt:
            ${{ github.event.inputs.prompt }}

            Codex output is saved in codex-output.md (in the workflow workspace).
          branch: codex/${{ github.run_id }}
          delete-branch: true
